name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - '[0-9]+.[0-9]+.[0-9]+'
    tags-ignore:
      - '**-*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      # - name: Install runtime deps
      #   run: pip install -r requirements.txt

      - name: Build package
        run: python -m build

      - name: Check package
        run: twine check dist/*

      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/*

  # publish-pypi:
  #   name: Publish to PyPI
  #   runs-on: ubuntu-latest
  #   needs: build
  #   permissions:
  #     id-token: write
  #   steps:
  #     - name: Download dist artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: dist
  #         path: dist

  #     - name: Publish to PyPI
  #       uses: pypa/gh-action-pypi-publish@release/v1

  publish-github:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - name: Download dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          files: |
            dist/*

  publish-deb:
    name: Build and Publish .deb Package
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: Install FPM
        run: |
          sudo apt-get update
          sudo gem install fpm

      - name: Build .deb package
        run: |
          VERSION="${GITHUB_REF_NAME#v}"

          # Extract wheel and install to temp directory
          TMPDIR=$(mktemp -d)
          mkdir -p "$TMPDIR/usr/local/bin"

          # Install semtag to temp directory
          pip install --prefix="$TMPDIR/usr/local" dist/semtag*.whl

          # Build .deb with FPM
          fpm -s dir \
            -t deb \
            -n semtag \
            -v "$VERSION" \
            -C "$TMPDIR" \
            -p semtag-${VERSION}-1_amd64.deb \
            --description "Tool for managing semantic version tags in git repositories" \
            --url "https://github.com/mateuszmikrut/semtag" \
            --license "MIT" \
            --depends "python3" \
            --depends "git" \
            usr/local/bin usr/local/lib

      - name: Upload .deb to Release
        uses: softprops/action-gh-release@v1
        with:
          files: semtag-*.deb

  # publish-homebrew:
  #   name: Publish Homebrew tap
  #   runs-on: ubuntu-latest
  #   needs:
  #     - publish-pypi
  #     - publish-github
  #   permissions:
  #     contents: write
  #   env:
  #     FORMULA_PATH: tap/Formula/semtag.rb
  #     TEMPLATE_PATH: tap/Templates/semtag.template
  #   steps:
  #     - name: Checkout semtag repo
  #       uses: actions/checkout@v4
  #       with:
  #         repository: mateuszmikrut/semtag
  #         path: semtag

  #     - name: Checkout tap repo
  #       uses: actions/checkout@v4
  #       with:
  #         repository: mateuszmikrut/homebrew-tap
  #         token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
  #         path: tap

  #     # - name: Create a branch for the update
  #     #   working-directory: tap
  #     #   run: |
  #     #     set -euo pipefail
  #     #     git checkout -b bump-semtag-"${GITHUB_REF_NAME}"

  #     - name: Update formula
  #       run: |
  #         set -euo pipefail
  #         TAG="${GITHUB_REF_NAME}"
  #         VERSION="${TAG#v}"
  #         TARBALL_URL="https://github.com/mateuszmikrut/semtag/releases/download/${VERSION}/semtag-${VERSION}.tar.gz"

  #         curl -sL "$TARBALL_URL" -o semtag.tar.gz
  #         TARBALL_SHA=$(shasum -a 256 semtag.tar.gz | awk '{print $1}')

  #         RESOURCES=""
  #         for pkg in $(grep -vE '^#|^$' semtag/requirements.txt ); do
  #           name=$(echo "$pkg" | sed 's/[>=<].*//')
  #           version=$(echo "$pkg" | sed 's/.*[>=]=//; s/[<>=].*//')

  #           pypi_url="https://pypi.org/pypi/${name}/${version}/json"
  #           response=$(curl -s "$pypi_url" | tr -d '\r')

  #           if ! echo "$response" | jq empty 2>/dev/null; then
  #             echo "ERROR: Failed to parse PyPI response for $pkg $version" >&2
  #             continue
  #           fi
  #           url=$(echo "$response" | jq -r '.urls[] | select(.packagetype=="sdist") | .url' | head -1)
  #           sha=$(echo "$response" | jq -r '.urls[] | select(.packagetype=="sdist") | .digests.sha256' | head -1)

  #           RESOURCES="$(printf "%s%s\n  resource \"%s\" do\n    url \"%s\"\n    sha256 \"%s\"\n  end\n\n" "$RESOURCES" "" "$name" "$url" "$sha")"
  #         done

  #         export RESOURCES
  #         export TARBALL_URL
  #         export TARBALL_SHA
  #         export VERSION

  #         envsubst < "${{ env.TEMPLATE_PATH }}" > "${{ env.FORMULA_PATH }}"

  #     - name: Commit and push changes
  #       working-directory: tap
  #       run: |
  #         set -euo pipefail
  #         git status --short
  #         if git diff --quiet; then
  #           echo "No changes to commit"
  #           exit 0
  #         fi
  #         git config user.name "github-actions[bot]"
  #         git config user.email "github-actions[bot]@users.noreply.github.com"
  #         git commit -am "Update semtag to ${GITHUB_REF_NAME}"
  #         git push
