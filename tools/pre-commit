#!/bin/bash
# Pre-commit hook to generate README.md options from script argparse help

### Install pre-commit hook:
# ln -s ../../tools/pre-commit .git/hooks/pre-commit

REPO_ROOT=$(git rev-parse --show-toplevel)

# Check if semtag.py has been modified
echo "Pre-commit hook running..."
if git diff --cached --name-only | grep -q semtag.py; then
  echo "Updating README.md options..."
  cd "$REPO_ROOT" || exit 1

  OPTIONS_TMP=$(mktemp)
  README_TMP=$(mktemp)

  # Prefer virtual environment python if exists
  if [ -d venv ];then
    PYPATH="$REPO_ROOT/venv/bin/python"
  else
    PYPATH="python3"
  fi

  $PYPATH semtag.py --help 2>&1 | sed -n '/^options:/,/^$/p' | tail -n +2 > "$OPTIONS_TMP"

  # README with updated options
  awk -v opts_file="$OPTIONS_TMP" '
    /<!-- OPTIONS:START -->/ { print; print "```"; system("cat " opts_file); print "```"; skip=1; next }
    /<!-- OPTIONS:END -->/ { skip=0 }
    !skip
  ' README.md > "$README_TMP"
    
  if [ $? -eq 0 ]; then
    mv "$README_TMP" README.md
    rm -f "$OPTIONS_TMP"
    git add README.md
    echo "README.md options updated and staged"
  else
    echo "Failed to update README.md"
    rm -f "$README_TMP" "$OPTIONS_TMP"
    exit 1
  fi
fi

# Update version in README.md installation instructions
echo "Updating version in README.md..."
LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/^v//')
if [ -n "$LATEST_TAG" ]; then
  README_TMP=$(mktemp)
  
  # Update DEB section
  awk -v version="$LATEST_TAG" '
    /<!-- VERSION:DEB:START -->/ { print; in_deb=1; next }
    /<!-- VERSION:DEB:END -->/ { 
      print "```bash"
      print "VERSION=\"" version "\""
      print "curl -LO \"https://github.com/mateuszmikrut/semtag/releases/download/${VERSION}/semtag-${VERSION}-1_amd64.deb\""
      print "sudo dpkg -i \"semtag-${VERSION}-1_amd64.deb\""
      print "```"
      print
      in_deb=0
      next
    }
    /<!-- VERSION:RPM:START -->/ { print; in_rpm=1; next }
    /<!-- VERSION:RPM:END -->/ {
      print "```bash"
      print "VERSION=\"" version "\""
      print "sudo dnf install https://github.com/mateuszmikrut/semtag/releases/download/${VERSION}/semtag-${VERSION}-1.x86_64.rpm"
      print "```"
      print
      in_rpm=0
      next
    }
    !in_deb && !in_rpm
  ' README.md > "$README_TMP"
  
  if [ $? -eq 0 ]; then
    mv "$README_TMP" README.md
    git add README.md
    echo "README.md version updated to $LATEST_TAG and staged"
  else
    echo "Failed to update README.md version"
    rm -f "$README_TMP"
  fi
fi

exit 0
